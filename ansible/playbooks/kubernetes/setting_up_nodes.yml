---
- hosts: kubernetes
  become: yes
  gather_facts: false
  vars_files:
  - ../vars/env_variables.yml
  tasks:
# Copiamos el repo de k8s en los nodos
  - name: Copy Kubernetes repo file to nodes.
    template:
      src: ../../template/repos/kubernetes.repo.template
      dest: /etc/yum.repos.d/Kubernetes.repo
      owner: root
      group: root
      mode: 0644
# Copiamos el repo de docker en los nodos
  - name: Copy Docker repo file to nodes.
    template:
      src: ../../template/repos/docker-ce.repo.template
      dest: /etc/yum.repos.d/Docker-ce.repo
      owner: root
      group: root
      mode: 0644
#    #Instalamos docker y su containerd
#  - name: Installing Docker
#    shell: |
#     dnf config-manager --add-repo=https://download.docker.com/linux/centos/docker-ce.repo
#     dnf install https://download.docker.com/linux/centos/7/x86_64/stable/Packages/containerd.io-1.2.6-3.3.el7.x86_64.rpm -y
#     dnf install docker-ce -y

#Instalamos los paquetes de kubernetes
  - name: Installing packages
    yum:
     name: "{{ packages }}"
     state: present
#Iniciamos los servicios necesarios
  - name: Starting and Enabling the required services
    service:
     name: "{{ item }}"
     state: started
     enabled: yes
    with_items: "{{ services }}"
#Habilitamos los puertos necesarios para el cluster
  - name: Allow Network Ports in Firewalld
    firewalld:
     port: "{{ item }}"
     state: enabled
     permanent: yes
     immediate: yes
    with_items: "{{ master_ports if ('kubernetes-master' in group_names) else worker_ports }}"

#  - name: Allow workers IPs in Firewalld
#    firewalld:
#      permanent: yes
#      immediate: yes
#      rich_rule: "{{ item }}"
#      state: enabled
#    with_items: "{{ ip_rich_rule if ('kubernetes-master' in group_names)}}"

